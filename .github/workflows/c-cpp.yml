name: Build FreeRDP

on:
  push:
    branches:
      - '**'  # 监听所有分支的提交事件

jobs:
  build:
    runs-on:  macos-13



    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          # 安装 Homebrew（如果尚未安装）
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          # 安装构建工具和依赖项（只装 SDL2 及其 TTF）
          brew install \
            ffmpeg \
            cjson \
            opus \
            cairo \
            json-c \
            pkg-config \
            cmake \
            ninja \
            sdl2 \
            sdl2_ttf
          
      - name: Clone FreeRDP repository
        run: |
          git clone https://github.com/FreeRDP/FreeRDP.git



      - name: Check SDL_ttf.h
        run: |
          sudo find /usr/local/ -name SDL_ttf.h


      - name: ls FreeRDP
        run: |
          ls /usr/local/Cellar/sdl2_ttf/2.24.0

      - name: ls FreeRDP
        run: |
          ls /usr/local/Cellar/sdl2_ttf/2.24.0/include/SDL2
          
      - name: Create build directory
        run: |
          cd FreeRDP
          mkdir build

      - name: Configure build options
        run: |
          cd FreeRDP/build
            cmake .. \
              -DCMAKE_BUILD_TYPE=Release \
              -DCMAKE_INSTALL_PREFIX=/usr/local \
              -DWITH_CAIRO=ON \
              -DWITH_FFMPEG=ON \
              -DWITH_OPUS=ON \
              -DWITH_JSONC=ON \
              -DWITH_LIBSYSTEMD=OFF \
              -DWITH_SDL2=ON \
              -DWITH_SDL3=OFF \
              -DWITH_CLIENT_SDL_VERSIONED=OFF \
              -DWITH_SDL2_TTF=ON \
              -DWITH_SDL3_TTF=OFF \
              -DCMAKE_C_FLAGS="-I/usr/local/include -I/usr/local/Cellar/sdl2_ttf/2.24.0/include/SDL2 -I/System/Volumes/Data/usr/local/include -I/System/Volumes/Data/usr/local/Cellar/sdl2_ttf/2.24.0/include/SDL2" \
              -DCMAKE_CXX_FLAGS="-I/usr/local/include -I/usr/local/Cellar/sdl2_ttf/2.24.0/include/SDL2 -I/System/Volumes/Data/usr/local/include -I/System/Volumes/Data/usr/local/Cellar/sdl2_ttf/2.24.0/include/SDL2" \
              -G Ninja

      - name: Build and install
        run: |
          cd FreeRDP/build
          ninja
          
      - name: Bundle binary with dependent dylibs and fix paths1
        run: |
          cd FreeRDP/build/client/SDL/SDL2
          mkdir -p bundle/lib
          cp sdl-freerdp bundle/
          deps=$(otool -L sdl-freerdp | grep dylib | awk '{print $1}' | grep -v /System)
          for dylib in $deps; do
            cp "$dylib" bundle/lib/
          done
          for dylib in bundle/lib/*.dylib; do
            dylibname=$(basename "$dylib")
            install_name_tool -change "$dylib" "@executable_path/lib/$dylibname" bundle/sdl-freerdp
          done
          install_name_tool -id "@executable_path/lib/$(basename bundle/sdl-freerdp)" bundle/sdl-freerdp
          cd bundle
          tar -czvf ../../freerdp-bundle.tar.gz .

      - name: Upload archive as artifact
        uses: actions/upload-artifact@v4
        with:
          name: freerdp-bundle-artifact
          path: FreeRDP/build/freerdp-bundle.tar.gz
        


